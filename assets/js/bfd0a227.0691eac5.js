"use strict";(self.webpackChunkcotton_box_docs=self.webpackChunkcotton_box_docs||[]).push([[647],{4872:(e,t,n)=>{n.d(t,{A:()=>_});var a=n(9136),s=n(7888);function o(e){const t=e.split("\n");for(let n=0;n<t.length;n++)t[n]=t[n].replace(/\s+$/,"");return t.join("\n")}var i=n(96540),r=n(34164),c=n(31177),l=n(204),d=n(64566);const h={codeBlockContainer:"codeBlockContainer_APcc"};var u=n(74848);function p(e){let{as:t,...n}=e;const a=(0,c.A)(),s=(0,d.M$)(a);return(0,u.jsx)(t,{...n,style:s,className:(0,r.A)(n.className,h.codeBlockContainer,l.G.common.codeBlock)})}const m={codeBlockContent:"codeBlockContent_m3Ux",codeBlockTitle:"codeBlockTitle_P25_",codeBlock:"codeBlock_qGQc",codeBlockStandalone:"codeBlockStandalone_zC50",codeBlockLines:"codeBlockLines_p187",codeBlockLinesWithNumbering:"codeBlockLinesWithNumbering_OFgW",buttonGroup:"buttonGroup_6DOT"};function g(e){let{children:t,className:n}=e;return(0,u.jsx)(p,{as:"pre",tabIndex:0,className:(0,r.A)(m.codeBlockStandalone,"thin-scrollbar",n),children:(0,u.jsx)("code",{className:m.codeBlockLines,children:t})})}var f=n(53115),x=n(61360),j=n(71765);const b={codeLine:"codeLine_iPqp",codeLineNumber:"codeLineNumber_F4P7",codeLineContent:"codeLineContent_pOih"};function S(e){let{line:t,classNames:n,showLineNumbers:a,getLineProps:s,getTokenProps:o}=e;1===t.length&&"\n"===t[0].content&&(t[0].content="");const i=s({line:t,className:(0,r.A)(n,a&&b.codeLine)}),c=t.map(((e,t)=>(0,u.jsx)("span",{...o({token:e})},t)));return(0,u.jsxs)("span",{...i,children:[a?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("span",{className:b.codeLineNumber}),(0,u.jsx)("span",{className:b.codeLineContent,children:c})]}):c,(0,u.jsx)("br",{})]})}var E=n(50190),w=n(50539),A=n(26220),k=n(29040);const y={copyButtonCopied:"copyButtonCopied__QnY",copyButtonIcons:"copyButtonIcons_FhaS",copyButtonIcon:"copyButtonIcon_phi_",copyButtonSuccessIcon:"copyButtonSuccessIcon_FfTR"};function N(e){let{code:t,className:n}=e;const[a,s]=(0,i.useState)(!1),o=(0,i.useRef)(void 0),c=(0,i.useCallback)((()=>{(0,E.A)(t),s(!0),o.current=window.setTimeout((()=>{s(!1)}),1e3)}),[t]);return(0,i.useEffect)((()=>()=>window.clearTimeout(o.current)),[]),(0,u.jsx)("button",{type:"button","aria-label":a?(0,w.T)({id:"theme.CodeBlock.copied",message:"Copied",description:"The copied button label on code blocks"}):(0,w.T)({id:"theme.CodeBlock.copyButtonAriaLabel",message:"Copy code to clipboard",description:"The ARIA label for copy code blocks button"}),title:(0,w.T)({id:"theme.CodeBlock.copy",message:"Copy",description:"The copy button label on code blocks"}),className:(0,r.A)("clean-btn",n,y.copyButton,a&&y.copyButtonCopied),onClick:c,children:(0,u.jsxs)("span",{className:y.copyButtonIcons,"aria-hidden":"true",children:[(0,u.jsx)(A.A,{className:y.copyButtonIcon}),(0,u.jsx)(k.A,{className:y.copyButtonSuccessIcon})]})})}var C=n(11645);const R={wordWrapButtonIcon:"wordWrapButtonIcon_iowe",wordWrapButtonEnabled:"wordWrapButtonEnabled_gY8A"};function B(e){let{className:t,onClick:n,isEnabled:a}=e;const s=(0,w.T)({id:"theme.CodeBlock.wordWrapToggle",message:"Toggle word wrap",description:"The title attribute for toggle word wrapping button of code block lines"});return(0,u.jsx)("button",{type:"button",onClick:n,className:(0,r.A)("clean-btn",t,a&&R.wordWrapButtonEnabled),"aria-label":s,title:s,children:(0,u.jsx)(C.A,{className:R.wordWrapButtonIcon,"aria-hidden":"true"})})}function T(e){let{children:t,className:n="",metastring:a,title:s,showLineNumbers:o,language:i}=e;const{prism:{defaultLanguage:l,magicComments:h}}=(0,f.p)(),g=function(e){return e?.toLowerCase()}(i??(0,d.Op)(n)??l),b=(0,c.A)(),E=(0,x.f)(),w=(0,d.wt)(a)||s,{lineClassNames:A,code:k}=(0,d.Li)(t,{metastring:a,language:g,magicComments:h}),y=o??(0,d._u)(a);return(0,u.jsxs)(p,{as:"div",className:(0,r.A)(n,g&&!n.includes(`language-${g}`)&&`language-${g}`),children:[w&&(0,u.jsx)("div",{className:m.codeBlockTitle,children:w}),(0,u.jsxs)("div",{className:m.codeBlockContent,children:[(0,u.jsx)(j.f4,{theme:b,code:k,language:g??"text",children:e=>{let{className:t,style:n,tokens:a,getLineProps:s,getTokenProps:o}=e;return(0,u.jsx)("pre",{tabIndex:0,ref:E.codeBlockRef,className:(0,r.A)(t,m.codeBlock,"thin-scrollbar"),style:n,children:(0,u.jsx)("code",{className:(0,r.A)(m.codeBlockLines,y&&m.codeBlockLinesWithNumbering),children:a.map(((e,t)=>(0,u.jsx)(S,{line:e,getLineProps:s,getTokenProps:o,classNames:A[t],showLineNumbers:y},t)))})})}}),(0,u.jsxs)("div",{className:m.buttonGroup,children:[(E.isEnabled||E.isCodeScrollable)&&(0,u.jsx)(B,{className:m.codeButton,onClick:()=>E.toggle(),isEnabled:E.isEnabled}),(0,u.jsx)(N,{className:m.codeButton,code:k})]})]})]})}function _(e){let{children:t,...n}=e;const r=(0,a.A)(),c=function(e){return i.Children.toArray(e).some((e=>(0,i.isValidElement)(e)))?e:Array.isArray(e)?e.join(""):e}(t),l="string"==typeof c?function(e,t,n){if(!e)return{data:"",unusedVariables:[]};const a=[];for(const s in t){const i=`-?{:${s}:}`;if((e.match(new RegExp(i,"g"))??[]).length>0){let a=t[s];n&&(a=o(a.replace(/\n/g,"\n * "))),e=e.replace(new RegExp(i,"g"),a)}else a.push(s)}return{data:e,unusedVariables:a}}(c,{CORE_PACKAGE_NAME:s.k.CORE_PACKAGE_NAME,REACT_PACKAGE_NAME:s.k.REACT_PACKAGE_NAME},!1).data:c,d="string"==typeof l?T:g;return(0,u.jsx)(d,{...n,children:l},String(r))}},32423:(e,t,n)=>{n.d(t,{W:()=>r});var a=n(4872),s=n(79329),o=n(65537),i=n(74848);function r(e){let{children:t,title:n}=e;const r=[];for(const o of t){const e=o.props.children.props.className;if(n&&o.props.children.props.metastring?.match(/title="/))throw new Error("metastring should not have title if it is already specified as a prop");if(e.match(/ts/gi))r.unshift((0,i.jsx)(s.A,{value:"ts",label:"TypeScript",default:!0,children:(0,i.jsx)(a.A,{language:"ts",metastring:o.props.children.props.metastring,title:n,children:o.props.children.props.children},"ts")}));else{if(!e.match(/js/gi))throw new Error(`Invalid className: ${e}`);r.push((0,i.jsx)(s.A,{value:"js",label:"JavaScript",children:(0,i.jsx)(a.A,{language:"js",metastring:o.props.children.props.metastring,title:n,children:o.props.children.props.children},"js")}))}}return(0,i.jsx)(o.A,{groupId:"language",children:r})}},53478:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>d,default:()=>m,frontMatter:()=>l,metadata:()=>a,toc:()=>u});const a=JSON.parse('{"id":"learn/tutorial/disposal","title":"Disposal","description":"General Usage","source":"@site/docs/learn/tutorial/disposal.mdx","sourceDirName":"learn/tutorial","slug":"/learn/tutorial/disposal","permalink":"/cotton-box/docs/learn/tutorial/disposal","draft":false,"unlisted":false,"editUrl":"https://github.com/glyph-cat/cotton-box/tree/main/packages/docs/docs/learn/tutorial/disposal.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"learnSidebar","previous":{"title":"Waiting For State Change","permalink":"/cotton-box/docs/learn/tutorial/waiting-for-state-change"},"next":{"title":"Persisting State","permalink":"/cotton-box/docs/learn/tutorial/persisting-state"}}');var s=n(74848),o=n(28453),i=n(57869),r=n(32423),c=n(7888);const l={sidebar_position:5},d="Disposal",h={},u=[{value:"General Usage",id:"general-usage",level:2},{value:"Using with React",id:"using-with-react",level:2}];function p(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"disposal",children:"Disposal"})}),"\n",(0,s.jsx)(t.h2,{id:"general-usage",children:"General Usage"}),"\n",(0,s.jsxs)(t.p,{children:["To dispose a State Manager, we use the ",(0,s.jsx)(t.code,{children:".dispose"})," method. This is important when the State Manager is not created/used globally."]}),"\n",(0,s.jsxs)(t.p,{children:["For example, we can have a ",(0,s.jsx)(t.code,{children:"GameRoom"})," class in which each instance has a state. Upon cleaning up the ",(0,s.jsx)(t.code,{children:"GameRoom"}),", we should also dispose the State Manager."]}),"\n",(0,s.jsxs)(r.W,{children:[(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:"import { StateManager } from '{:CORE_PACKAGE_NAME:}'\n\nenum GameRoomState {\n  CREATED,\n  INITIALIZED,\n  STARTED,\n  STOPPED,\n  DISPOSED,\n}\n\nclass GameRoom {\n\n  state = new StateManager<GameRoomState>(GameRoomState.CREATED)\n\n  async dispose(): Promise<void> {\n    await this.state.wait((state) => { return state >= GameRoomState.INITIALIZED })\n    // ^ Pro tip: Wait for initialization to complete before performing teardown\n    this.state.set(GameRoomState.DISPOSED)\n    this.state.dispose()\n  }\n\n}\n"})}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-jsx",children:"import { StateManager } from '{:CORE_PACKAGE_NAME:}'\n\nconst GameRoomState = Object.freeze({\n  CREATED: 0,\n  INITIALIZED: 1,\n  STARTED: 2,\n  STOPPED: 3,\n  DISPOSED: 4,\n})\n\nclass GameRoom {\n\n  state = new StateManager(GameRoomState.CREATED)\n\n  async dispose() {\n    await this.state.wait((state) => { return state >= GameRoomState.INITIALIZED })\n    // ^ Pro tip: Wait for initialization to complete before performing teardown\n    this.state.set(GameRoomState.DISPOSED)\n    this.state.dispose()\n  }\n\n}\n"})})]}),"\n",(0,s.jsx)(t.h2,{id:"using-with-react",children:"Using with React"}),"\n",(0,s.jsxs)(t.p,{children:["To recap, State Managers are designed to be used globally most of the time, but there are niche cases where they need to be dynamically created (and disposed). One such example is to dynamically create them within React components. In React, we can ",(0,s.jsx)(t.a,{href:"https://react.dev/reference/react/useRef#avoiding-recreating-the-ref-contents",children:'"lazily initialize"'})," the variables for ",(0,s.jsx)(i.L,{href:c.k.REACT_DOCS_SITE_USE_REF_URL,children:"useRef"})," and State Managers can be instantiated in a similar way too."]}),"\n",(0,s.jsxs)(r.W,{children:[(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:"function App(): JSX.Element {\n  const ExampleState = useRef<StateManager<string>>()\n  if (!ExampleState.current) {\n    ExampleState.current = new StateManager<string>('...')\n  }\n  useEffect(() => {\n    return () => {\n      ExampleState.current.dispose()\n    }\n  }, [])\n  console.log(ExampleState.current.get())\n  return '...'\n}\n"})}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-jsx",children:"function App() {\n  const ExampleState = useRef(null)\n  if (!ExampleState.current) {\n    ExampleState.current = new StateManager('...')\n  }\n  useEffect(() => {\n    return () => {\n      ExampleState.current.dispose()\n    }\n  }, [])\n  console.log(ExampleState.current.get())\n  return '...'\n}\n"})})]}),"\n",(0,s.jsxs)(t.p,{children:["However, it can be tricky (",(0,s.jsx)(t.a,{href:"https://github.com/facebook/react/issues/14490",children:"#14490"}),", ",(0,s.jsx)(t.a,{href:"https://github.com/facebook/react/issues/26315",children:"#26315"}),", ",(0,s.jsx)(t.a,{href:"https://github.com/facebook/react/issues/27735",children:"#27735"}),") to do this in ",(0,s.jsx)(i.L,{href:c.k.REACT_DOCS_SITE_STRICT_MODE_URL,children:"StrictMode"})," due to how the effects are being fired:"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Setup effect is called for the first time."}),"\n",(0,s.jsx)(t.li,{children:"Setup effect is called for the second time."}),"\n",(0,s.jsx)(t.li,{children:"Cleanup effect is called for the first time."}),"\n",(0,s.jsx)(t.li,{children:"When component finally unmounts, cleanup effect is called for the second time."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Which translates into:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Variable is instantiated for the first time and assigned to ",(0,s.jsx)(t.code,{children:"useRef"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["Variable is instantiated for the ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"second"})})," time and ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"overwrites"})})," the ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"first"})})," value that is already assigned to ",(0,s.jsx)(t.code,{children:"useRef"}),". (You would think ",(0,s.jsx)(t.code,{children:"ExampleState.current"})," already has a value at this point, but for some reason, it is in fact still ",(0,s.jsx)(t.code,{children:"null"}),")."]}),"\n",(0,s.jsxs)(t.li,{children:["Cleanup effect is run for the ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"first"})})," time on the variable assigned to ",(0,s.jsx)(t.code,{children:"useRef"})," (which is the ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"second"})})," instance)."]}),"\n",(0,s.jsxs)(t.li,{children:["When component finally unmounts, the cleanup effect is run for the second time on whatever value that ",(0,s.jsx)(t.code,{children:"useRef"})," may still be holding."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:['There are a few workarounds for this problem, but at a higher level, this means that we are in some way still writing "unsafe" code \u2014 code that might lead to bugs in future versions of React or when we begin to adopt certain new features of React in the future. Instead of (1)setup -> (2)cleanup -> (3)setup -> (4)cleanup, ',(0,s.jsx)(t.code,{children:"StrictMode"})," triggers (1)setup -> (2)setup -> (3)cleanup -> (4)cleanup. For now, we can think about it this way: it is possible for the same component to be rendered more than once before the first instance even has the chance to cleanup. Even if we intend for a component to only have one rendered instance at a time throughout the entire app, in reality, there is no guarantee that it would be rendered that way, and ",(0,s.jsx)(t.code,{children:"StrictMode"})," helps to simulate such conditions which allows us to identify problems that may occur when components are rendered in such a way."]}),"\n",(0,s.jsx)(t.p,{children:"It seems like the only safe and stable way so far is to perform both the instantiation and cleanup in the same effect. The downside to this is that the lazily initialized values will not be accessible in the first render and we will need to implement some sort of fallback UI or perform actions that are related to the lazily initialized value only when it becomes available."}),"\n",(0,s.jsxs)(r.W,{children:[(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:"function App(): JSX.Element {\n  const [ExampleState, setExampleState] = useState<StateManager<string>>(null)\n  useEffect(() => {\n    const newExampleState = new StateManager<string>('...')\n    setExampleState(newExampleState)\n    return () => {\n      newExampleState.dispose()\n      setExampleState(null)\n    }\n  }, [])\n  if (!ExampleState) { return <>Loading...</> }\n  console.log(ExampleState.get())\n  return '...'\n}\n"})}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-jsx",children:"function App() {\n  const [ExampleState, setExampleState] = useState(null)\n  useEffect(() => {\n    const newExampleState = new StateManager('...')\n    setExampleState(newExampleState)\n    return () => {\n      newExampleState.dispose()\n      setExampleState(null)\n    }\n  }, [])\n  if (!ExampleState) { return <>Loading...</> }\n  console.log(ExampleState.get())\n  return '...'\n}\n"})})]})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}}}]);